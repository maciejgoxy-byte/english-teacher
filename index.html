<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>English Teacher Voice</title>

<style>
body {
    margin: 0;
    font-family: Arial, sans-serif;
    height: 100vh;
    display: flex;
    flex-direction: column;
    background: linear-gradient(135deg, #667eea, #764ba2);
}
.header {
    background: #fff;
    padding: 10px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}
.logo {
    width: 40px;
    height: 40px;
    background: #667eea;
    color: #fff;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
}
.messages {
    flex: 1;
    overflow-y: auto;
    padding: 10px;
}
.message {
    padding: 10px 14px;
    border-radius: 18px;
    margin-bottom: 8px;
    max-width: 85%;
}
.user {
    background: #667eea;
    color: #fff;
    margin-left: auto;
}
.ai {
    background: #fff;
    color: #111;
}
.input {
    display: flex;
    gap: 8px;
    padding: 10px;
    background: #fff;
}
button {
    border: none;
    border-radius: 20px;
    padding: 10px 14px;
    cursor: pointer;
}
.voice-on {
    background: #10b981;
    color: #fff;
}
.voice-off {
    background: #e5e7eb;
}
.status {
    text-align: center;
    font-size: 12px;
    color: red;
}
.hidden {
    display: none;
}
</style>
</head>

<body>

<div class="header">
    <div style="display:flex;gap:10px;align-items:center">
        <div class="logo">EN</div>
        <strong>English Teacher</strong>
    </div>
    <button id="modeBtn" class="voice-off" onclick="toggleVoice()">OFF</button>
</div>

<div id="messages" class="messages"></div>
<div id="status" class="status hidden">ðŸŽ¤ Listening...</div>

<div class="input">
    <input id="textInput" style="flex:1" placeholder="Type or speak..." />
    <button onclick="sendText()">âž¤</button>
</div>

<script>
let apiKey = localStorage.getItem('groq_api_key') || '';
if (!apiKey) {
    apiKey = prompt('Paste your Groq API key (gsk_...)');
    localStorage.setItem('groq_api_key', apiKey);
}

let recognition;
let voiceEnabled = false;
let isSpeaking = false;
let isLoading = false;
let messages = [];

/* ---------- SPEECH ---------- */
function speak(text, onEnd) {
    if (!('speechSynthesis' in window)) return;

    speechSynthesis.cancel();
    const u = new SpeechSynthesisUtterance(text);
    u.lang = 'en-US';
    u.rate = 0.9;

    const voices = speechSynthesis.getVoices();
    const v = voices.find(x => x.lang.startsWith('en'));
    if (v) u.voice = v;

    isSpeaking = true;
    u.onend = () => {
        isSpeaking = false;
        if (onEnd) onEnd();
    };

    speechSynthesis.speak(u);
}

speechSynthesis.onvoiceschanged = () => speechSynthesis.getVoices();

/* ---------- MIC ---------- */
function initMic() {
    const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (!SR) return alert('SpeechRecognition not supported');

    recognition = new SR();
    recognition.lang = 'en-US';
    recognition.continuous = false;

    recognition.onresult = e => {
        stopMic();
        sendVoice(e.results[0][0].transcript);
    };

    recognition.onend = () => {
        if (voiceEnabled && !isSpeaking && !isLoading) startMic();
    };
}

function startMic() {
    if (!recognition) return;
    recognition.start();
    document.getElementById('status').classList.remove('hidden');
}

function stopMic() {
    if (recognition) recognition.stop();
    document.getElementById('status').classList.add('hidden');
}

/* ---------- UI ---------- */
function addMessage(text, who) {
    messages.push({ role: who === 'user' ? 'user' : 'assistant', content: text });
    const d = document.createElement('div');
    d.className = 'message ' + (who === 'user' ? 'user' : 'ai');
    d.textContent = text;
    document.getElementById('messages').appendChild(d);
    d.scrollIntoView();
}

function toggleVoice() {
    voiceEnabled = !voiceEnabled;
    const btn = document.getElementById('modeBtn');

    if (voiceEnabled) {
        btn.textContent = 'VOICE ON';
        btn.className = 'voice-on';
        alert('Voice mode ON\nSpeak after the beep.');
        startMic();
    } else {
        btn.textContent = 'OFF';
        btn.className = 'voice-off';
        stopMic();
        speechSynthesis.cancel();
    }
}

/* ---------- SEND ---------- */
async function sendText() {
    const t = document.getElementById('textInput').value.trim();
    if (!t) return;
    document.getElementById('textInput').value = '';
    await talk(t);
}

async function sendVoice(text) {
    await talk(text);
}

async function talk(text) {
    if (isLoading) return;
    isLoading = true;
    addMessage(text, 'user');

    try {
        const r = await fetch('https://api.groq.com/openai/v1/chat/completions', {
            method: 'POST',
            headers: {
                'Authorization': 'Bearer ' + apiKey,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                model: 'llama-3.3-70b-versatile',
                messages: [
                    { role: 'system', content: 'You are a friendly English teacher. Correct gently. Short answers.' },
                    ...messages
                ],
                temperature: 0.7
            })
        });

        const data = await r.json();
        const reply = data.choices[0].message.content;
        addMessage(reply, 'ai');

        if (voiceEnabled) {
            speak(reply, () => startMic());
        } else {
            speak(reply);
        }

    } catch {
        addMessage('Error connecting to AI.', 'ai');
    }

    isLoading = false;
}

initMic();
addMessage("Hello! I'm your English teacher. Tap VOICE ON to talk.", 'ai');
</script>

</body>
</html>
